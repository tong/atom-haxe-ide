(function(B){function H(a,b){function c(){}c.prototype=a;var g=new c,e;for(e in b)g[e]=b[e];b.toString!==Object.prototype.toString&&(g.toString=b.toString);return g}function u(a,b){if(null==b)return null;null==b.__id__&&(b.__id__=M++);var c;null==a.hx__closures__?a.hx__closures__={}:c=a.hx__closures__[b.__id__];null==c&&(c=function(){return c.method.apply(c.scope,arguments)},c.scope=a,c.method=b,a.hx__closures__[b.__id__]=c);return c}B.xxx=B.xxx||{};var I=function(){return q.__string_rec(this,"")},
w=function(a,b){this.r=new RegExp(a,b.split("u").join(""))};w.__name__=!0;w.prototype={match:function(a){this.r.global&&(this.r.lastIndex=0);this.r.m=this.r.exec(a);this.r.s=a;return null!=this.r.m},matched:function(a){if(null!=this.r.m&&0<=a&&a<this.r.m.length)return this.r.m[a];throw new r("EReg::matched");}};var m=function(){};m.__name__=!0;m.cca=function(a,b){var c=a.charCodeAt(b);return c!=c?void 0:c};m.substr=function(a,b,c){if(null==c)c=a.length;else if(0>c)if(0==b)c=a.length+c;else return"";
return a.substr(b,c)};Math.__name__=!0;var h=function(){};h.__name__=!0;h.string=function(a){return q.__string_rec(a,"")};h.parseInt=function(a){var b=parseInt(a,10);0!=b||120!=m.cca(a,1)&&88!=m.cca(a,1)||(b=parseInt(a));return isNaN(b)?null:b};var l=function(){};l.__name__=!0;l.isSpace=function(a,b){var c=m.cca(a,b);return 8<c&&14>c?!0:32==c};l.ltrim=function(a){for(var b=a.length,c=0;c<b&&l.isSpace(a,c);)++c;return 0<c?m.substr(a,c,b-c):a};l.rtrim=function(a){for(var b=a.length,c=0;c<b&&l.isSpace(a,
b-c-1);)++c;return 0<c?m.substr(a,0,b-c):a};l.trim=function(a){return l.ltrim(l.rtrim(a))};l.replace=function(a,b,c){return a.split(b).join(c)};var N=require("atom").CompositeDisposable,y=require("atom").Emitter,J=require("atom").File,K=require("atom").Point,O=require("atom").Range,x=function(a){var b=this;this.id=setInterval(function(){b.run()},a)};x.__name__=!0;x.delay=function(a,b){var c=new x(b);c.run=function(){c.stop();a()};return c};x.prototype={stop:function(){null!=this.id&&(clearInterval(this.id),
this.id=null)},run:function(){}};var p=function(a){switch(a){case ".":case "..":this.dir=a;this.file="";return}var b=a.lastIndexOf("/"),c=a.lastIndexOf("\\");b<c?(this.dir=m.substr(a,0,c),a=m.substr(a,c+1,null),this.backslash=!0):c<b?(this.dir=m.substr(a,0,b),a=m.substr(a,b+1,null)):this.dir=null;b=a.lastIndexOf(".");-1!=b?(this.ext=m.substr(a,b+1,null),this.file=m.substr(a,0,b)):(this.ext=null,this.file=a)};p.__name__=!0;p.withoutExtension=function(a){a=new p(a);a.ext=null;return a.toString()};p.withoutDirectory=
function(a){a=new p(a);a.dir=null;return a.toString()};p.extension=function(a){a=new p(a);return null==a.ext?"":a.ext};p.prototype={toString:function(){return(null==this.dir?"":this.dir+(this.backslash?"\\":"/"))+this.file+(null==this.ext?"":"."+this.ext)}};var r=function(a){Error.call(this);this.val=a;this.message=String(a);Error.captureStackTrace&&Error.captureStackTrace(this,r)};r.__name__=!0;r.wrap=function(a){return a instanceof Error?a:new r(a)};r.__super__=Error;r.prototype=H(Error.prototype,
{});var q=function(){};q.__name__=!0;q.__string_rec=function(a,b){if(null==a)return"null";if(5<=b.length)return"<...>";var c=typeof a;"function"==c&&(a.__name__||a.__ename__)&&(c="object");switch(c){case "function":return"<function>";case "object":if(a instanceof Array){if(a.__enum__){if(2==a.length)return a[0];c=a[0]+"(";b+="\t";for(var g=2,e=a.length;g<e;)var d=g++,c=2!=d?c+(","+q.__string_rec(a[d],b)):c+q.__string_rec(a[d],b);return c+")"}c=a.length;g="[";b+="\t";for(e=0;e<c;)d=e++,g+=(0<d?",":
"")+q.__string_rec(a[d],b);return g+"]"}try{g=a.toString}catch(f){return"???"}if(null!=g&&g!=Object.toString&&"function"==typeof g&&(c=a.toString(),"[object Object]"!=c))return c;c=null;g="{\n";b+="\t";e=null!=a.hasOwnProperty;for(c in a)e&&!a.hasOwnProperty(c)||"prototype"==c||"__class__"==c||"__super__"==c||"__interfaces__"==c||"__properties__"==c||(2!=g.length&&(g+=", \n"),g+=b+c+" : "+q.__string_rec(a[c],b));b=b.substring(1);return g+("\n"+b+"}");case "string":return a;default:return String(a)}};
var P=require("child_process"),L=require("fs"),Q=require("path"),t=require("buffer").Buffer,k=function(){};k.__name__=!0;k.parse=function(a){if(k.PATTERN.match(a)){a=new k;a.path=k.PATTERN.matched(1);a.line=h.parseInt(k.PATTERN.matched(2));switch(k.PATTERN.matched(3)){case "character":a.character=h.parseInt(k.PATTERN.matched(4));a.content=k.PATTERN.matched(7);break;case "characters":a.characters={start:h.parseInt(k.PATTERN.matched(4)),end:h.parseInt(k.PATTERN.matched(6))};a.content=k.PATTERN.matched(7);
break;case "lines":a.lines={start:h.parseInt(k.PATTERN.matched(4)),end:h.parseInt(k.PATTERN.matched(6))},a.content=k.PATTERN.matched(7)}return a}return null};var C=function(a,b){null==b&&(b=!0);null==a&&(a="haxe");this.haxePath=a;this.verbose=b};C.__name__=!0;C.prototype={start:function(a){this.stop();this.buffer=new D;this.nextMessageLength=-1;this.process=P.spawn(this.haxePath,["-v","--wait","stdio"]);this.process.on("exit",u(this,this.handleExit));this.process.stderr.on("data",u(this,this.handleData));
this.process.stdout.on("data",function(a){});this.getVersion(function(b){b=f.stringToVersion(b);b=f.lessThan(b,f.stringToVersion("3.3.0"))?"haxe >= 3.3.0 required":null;a(b)})},stop:function(){if(null!=this.process){this.process.removeAllListeners();try{this.process.kill()}catch(b){}this.process=null}for(var a=this.requestsHead;null!=a;)a.processResult(null),a=a.next;this.requestsHead=this.requestsTail=this.currentRequest=null},getVersion:function(a){this.query(["-version"],null,a,function(a){})},
query:function(a,b,c,g,e){a=new E(a,b,c,g,e);null==this.requestsHead?this.requestsHead=this.requestsTail=a:(this.requestsTail.next=a,a.prev=this.requestsTail,this.requestsTail=a);this.checkQueue()},checkQueue:function(){null==this.currentRequest&&null!=this.requestsHead&&(this.currentRequest=this.requestsHead,this.requestsHead=this.currentRequest.next,this.process.stdin.write(this.currentRequest.prepareBody()))},handleData:function(a){for(this.buffer.append(a);;){if(-1==this.nextMessageLength){a=
this.buffer.tryReadLength();if(-1==a)break;this.nextMessageLength=a}a=this.buffer.tryReadContent(this.nextMessageLength);if(null==a)break;this.nextMessageLength=-1;if(null!=this.currentRequest){var b=this.currentRequest;this.currentRequest=null;b.processResult(a);this.checkQueue()}}},handleExit:function(a,b){}};var D=function(a){null==a&&(a=8192);this.size=a;this.buffer=new t(a);this.index=0};D.__name__=!0;D.prototype={append:function(a){if(this.buffer.length-this.index>=a.length)a.copy(this.buffer,
this.index,0,a.length);else{var b=(Math.ceil((this.index+a.length)/this.size)+1)*this.size|0;0==this.index?(this.buffer=new t(b),a.copy(this.buffer,0,0,a.length)):this.buffer=t.concat([this.buffer.slice(0,this.index),a],b)}this.index+=a.length},tryReadLength:function(){if(4>this.index)return-1;var a=this.buffer.readInt32LE(0);this.buffer=this.buffer.slice(4);this.index-=4;return a},tryReadContent:function(a){if(this.index<a)return null;var b=this.buffer.toString("utf-8",0,a);this.buffer.copy(this.buffer,
0,a);this.index-=a;return b}};var E=function(a,b,c,g,e){this.args=a;this.stdin=b;this.onResult=c;this.onError=g;this.onMessage=e};E.__name__=!0;E.prototype={prepareBody:function(){null!=this.stdin&&(this.args=this.args.concat(["-D","display-stdin"]));for(var a=new t(4),b=[a],c=0,g=0,e=this.args;g<e.length;){var d=e[g];++g;d=new t(""+d+"\n");b.push(d);c+=d.length}null!=this.stdin&&(g=new t([1]),b.push(g),e=new t(this.stdin),b.push(e),c+=e.length+g.length);a.writeInt32LE(c,0);return t.concat(b,c+4)},
processResult:function(a){if(null==a)this.onResult(null);else{var b="",c=!1,d=0;for(a=a.split("\n");d<a.length;){var e=a[d];++d;switch(e.charCodeAt(0)){case 1:e=l.replace(e.substring(1),"\u0001","\n");if(null!=this.onMessage)this.onMessage(e);break;case 2:c=!0;break;default:b+=null==e?"null":""+e,b+="\n"}}b=l.trim(b);if(c)this.onError(b);else this.onResult(b)}}};var f={__name__:!0,stringToVersion:function(a){if(!f.VERSION.match(a))throw new r('Invalid SemVer format for "'+a+'"');a=h.parseInt(f.VERSION.matched(1));
var b=h.parseInt(f.VERSION.matched(2)),c=h.parseInt(f.VERSION.matched(3)),d=f.parseIdentifiers(f.VERSION.matched(4)),e=f.parseIdentifiers(f.VERSION.matched(5));return{version:[a,b,c],pre:d,build:e}},equals:function(a,b){return a.version[0]!=b.version[0]||a.version[1]!=b.version[1]||a.version[2]!=b.version[2]?!1:f.equalsIdentifiers(a.pre,b.pre)},greaterThan:function(a,b){return 0<a.pre.length&&0<b.pre.length?a.version[0]==b.version[0]&&a.version[1]==b.version[1]&&a.version[2]==b.version[2]?f.greaterThanIdentifiers(a.pre,
b.pre):!1:0<b.pre.length?a.version[0]!=b.version[0]?a.version[0]>b.version[0]:a.version[1]!=b.version[1]?a.version[1]>b.version[1]:a.version[2]!=b.version[2]?a.version[2]>b.version[2]:0<a.pre.length?f.greaterThanIdentifiers(a.pre,b.pre):!0:0>=a.pre.length?a.version[0]!=b.version[0]?a.version[0]>b.version[0]:a.version[1]!=b.version[1]?a.version[1]>b.version[1]:a.version[2]!=b.version[2]?a.version[2]>b.version[2]:f.greaterThanIdentifiers(a.pre,b.pre):!1},greaterThanOrEqual:function(a,b){return f.equals(a,
b)?!0:f.greaterThan(a,b)},lessThan:function(a,b){return!f.greaterThanOrEqual(a,b)},parseIdentifiers:function(a){return(null==a?"":a).split(".").map(f.sanitize).filter(function(a){return""!=a}).map(f.parseIdentifier)},parseIdentifier:function(a){var b=h.parseInt(a);return null==b?z.StringId(a):z.IntId(b)},equalsIdentifiers:function(a,b){if(a.length!=b.length)return!1;for(var c=0,d=a.length;c<d;){var e=c++,f=b[e],e=a[e];switch(e[1]){case 0:if(0==f[1]&&e[2]!=f[2])return!1;break;case 1:if(1==f[1]&&e[2]!=
f[2])return!1}}return!0},greaterThanIdentifiers:function(a,b){for(var c=0,d=a.length;c<d;){var e=c++,f=b[e],e=a[e];switch(e[1]){case 0:switch(f[1]){case 0:if(e[2]==f[2])continue;else return e[2]>f[2]?!0:!1;case 1:return!0;default:return!1}case 1:if(1==f[1])if(e[2]==f[2])continue;else return e[2]>f[2]?!0:!1;else return!1;default:return!1}}return!1},sanitize:function(a){return a.replace(f.SANITIZER.r,"")}},z={__ename__:!0,__constructs__:["StringId","IntId"],StringId:function(a){a=["StringId",0,a];a.__enum__=
z;a.toString=I;return a},IntId:function(a){a=["IntId",1,a];a.__enum__=z;a.toString=I;return a}},F=function(){this.excludeLowerPriority=!1;this.inclusionPriority=2;this.disableForSelector=".source.haxe .comment, .source.hx .comment";this.selector=".source.haxe, .source.hx"};F.__name__=!0;F.prototype={dispose:function(){},getSuggestions:function(a){return new Promise(function(a,c){a([])})}};var A=function(a){y.call(this);this.hxml=a};A.__name__=!0;A.__super__=y;A.prototype=H(y.prototype,{start:function(a){null==
a&&(a=!1);var b=this;this.args=["--cwd",this.hxml.getParent().getPath()];a&&this.args.push("-v");this.args.push(this.hxml.getBaseName());d.server.query(this.args,null,function(a){b.emit("end",0)},function(a){a=l.trim(a);b.emit("error",a);b.emit("end",null)},function(a){b.emit("message",a)});this.emit("start",null)}});var d=B.xxx.IDE=function(){};d.__name__=!0;d.activate=function(a){d.disposables=new N;d.emitter=new y;d.statusbar=new v;d.server=new C(atom.config.get("xxx.haxe_path"));x.delay(function(){d.server.start(function(a){null!=
a?atom.notifications.addWarning(a):d.disposables.add(atom.commands.add("atom-workspace","xxx:build",function(a){a=d.getTreeViewFile();null!=a&&"hxml"==p.extension(a)&&null!=d.hxml&&a!=d.hxml.getPath()&&d.selectHxml(a);d.build()}))})},atom.config.get("xxx.haxe_server_startdelay"));d.searchHxmlFiles(null,null,function(b){d.hxmlFiles=b;null!=a&&null!=a.hxml?-1!=d.hxmlFiles.indexOf(a.hxml)&&d.selectHxml(a.hxml):d.selectHxml(b[0]);atom.workspace.observeTextEditors(function(a){var b=a.getPath();if(null!=
b&&"hx"==p.extension(b))a.onDidChange(function(a){})})})};d.serialize=function(){return{hxml:null!=d.hxml?d.hxml.getPath():null}};d.deactivate=function(){d.disposables.dispose();d.server.stop()};d.onSelectHxml=function(a){return d.emitter.on("hxml_select",a)};d.onBuild=function(a){return d.emitter.on("build",a)};d.selectHxml=function(a){if(null==a)d.hxml=null;else{if(null!=d.hxml&&a==d.hxml.getPath())return;d.hxml=new J(a)}d.emitter.emit("hxml_select",d.hxml)};d.build=function(){if(null==d.hxml)return atom.notifications.addWarning("No hxml file selected"),
null;var a=new A(d.hxml);new n(a);d.emitter.emit("build",a);a.start();return a};d.searchHxmlFiles=function(a,b,c){null==b&&(b=3);null==a&&(a=atom.project.getPaths());for(var d=function(a,c,e){null==e&&(e=0);var f=[];L.readdir(a,function(k,h){var m=h.length;if(0==m)c(f);else for(var l=0;l<h.length;){var n=[h[l]];++l;var q=Q.resolve(a,n[0]);n[0]=q;L.stat(n[0],function(a){return function(h,k){if(null!=k&&k.isDirectory())if(e<b){var l=a[0],n=function(){return function(a){f=f.concat(a);0==--m&&c(f)}}();
d(l,n,e+1)}else 0==--m&&c(f);else"hxml"==p.extension(a[0])&&"extraParams.hxml"!=p.withoutDirectory(a[0])&&f.push(a[0]),0==--m&&c(f)}}(n))}})},e=[],f=0,k=0;k<a.length;){var h=a[k];++k;d(h,function(b){e=e.concat(b);(f+=1)==a.length&&c(e)})}};d.getTreeViewFile=function(a){var b=atom.packages.getLoadedPackage("tree-view").serialize();if(null==b)return null;b=b.selectedPath;return null==a||null!=b&&p.extension(b)==a?b:null};d.getConfig=function(a){return atom.config.get("xxx."+a)};d.consumeStatusBar=function(a){a.addLeftTile({item:d.statusbar.element,
priority:-100})};d.provideAutoCompletion=function(){return new F};d.provideService=function(){return{getHxml:function(){return d.hxml},selectHxml:d.selectHxml,build:d.build}};var G=function(a,b){this.error=b;this.element=window.document.createElement("li");this.element.classList.add("message","error");var c=window.document.createElement("i");c.textContent=h.string(a+1);this.element.appendChild(c);c=window.document.createElement("span");c.classList.add("path");c.textContent=b.path;this.element.appendChild(c);
c=window.document.createElement("span");c.classList.add("line");c.textContent=null==b.line?"null":""+b.line;this.element.appendChild(c);null!=b.characters&&(c=window.document.createElement("span"),c.classList.add("start"),c.textContent=h.string(b.characters.start),this.element.appendChild(c),c=window.document.createElement("span"),c.classList.add("end"),c.textContent=h.string(b.characters.end),this.element.appendChild(c));c=window.document.createElement("span");c.classList.add("content");c.textContent=
b.content;this.element.appendChild(c)};G.__name__=!0;G.prototype={select:function(){}};var n=function(a){var b=this;null!=n.current&&n.current.destroy();n.current=this;this.element=window.document.createElement("div");this.element.classList.add("xxx-build","resizer");this.messages=window.document.createElement("ol");this.messages.classList.add("messages","scroller");this.element.appendChild(this.messages);this.panel=atom.workspace.addBottomPanel({item:this.element,visible:!0});var c=[];a.on("start",
function(){c=[]});a.on("message",function(a){b.log(a)});a.on("error",function(a){for(var d=0,f=a.split("\n");d<f.length;){var h=f[d];++d;h=[k.parse(h)];if(null==h[0])b.log(a,"error");else{c.push(h[0]);var l=[new G(b.messages.children.length,h[0])];l[0].element.onclick=function(a,b){return function(){a[0].select();n.openErrorPosition(b[0])}}(l,h);b.messages.appendChild(l[0].element)}}});a.on("end",function(d){if(0==d)0==b.messages.children.length&&b.panel.hide();else if(0<c.length)if(d=c[0],(new J(d.path,
!1)).existsSync())n.openErrorPosition(d);else{var e=atom.project.relativizePath(a.hxml.getPath());d.path=e[0]+"/"+d.path}});this.element.addEventListener("click",u(this,this.handleClick),!1)};n.__name__=!0;n.openPosition=function(a,b,c,d,e,f){null==e&&(e=!0);null==d&&(d=!0);atom.workspace.open(a,{initialLine:b,initialColumn:c,activatePane:d,searchAllPanes:e}).then(function(a){null!=f&&f(a)})};n.openErrorPosition=function(a){var b=a.line-1;n.openPosition(a.path,b,a.character,null,null,function(c){null!=
a.characters&&c.setSelectedBufferRange(new O(new K(b,a.characters.start),new K(b,a.characters.end)))})};n.prototype={destroy:function(){this.panel.destroy()},log:function(a,b){a=l.trim(a);if(0!=a.length){var c=window.document.createElement("li");c.classList.add("message");null!=b&&c.classList.add(b);c.textContent=a;this.messages.appendChild(c)}},handleClick:function(a){a.ctrlKey&&this.panel.hide()}};var v=function(){var a=this;this.element=window.document.createElement("div");this.element.classList.add("status-bar-xxx",
"inline-block");this.icon=window.document.createElement("span");this.icon.classList.add("icon-haxe");this.element.appendChild(this.icon);this.info=window.document.createElement("a");this.info.classList.add("info");this.element.appendChild(this.info);this.meta=window.document.createElement("span");this.meta.classList.add("meta");this.element.appendChild(this.meta);d.emitter.on("hxml_select",u(this,this.changeHxml));d.emitter.on("build",function(b){var c=null,d=0;b.on("start",function(){var b=process.hrtime();
c=(1E9*b[0]+b[1])/1E6;a.changeStatus("active")});b.on("message",function(a){});b.on("error",function(b){d+=1;a.changeStatus("error")});b.on("end",function(b){if(0==b){a.changeStatus("success");b=process.hrtime();b=((1E9*b[0]+b[1])/1E6-c)/1E3;b=null==b?"null":""+b;var f=b.indexOf(".");b=b.substring(0,f)+b.substring(f,3);a.meta.textContent=b+"s"}else a.changeStatus("error"),a.meta.textContent="("+d+")"})});this.info.addEventListener("click",u(this,this.handleClickInfo),!1)};v.__name__=!0;v.getRelativePath=
function(a){a=atom.project.relativizePath(a);var b=a[0].split("/");return b[b.length-1]+"/"+a[1]};v.prototype={dispose:function(){this.info.removeEventListener("click",u(this,this.handleClickInfo));null!=this.contextMenu&&this.contextMenu.dispose()},changeHxml:function(a){null==a?(this.icon.style.display="none",this.info.textContent=""):(this.icon.style.display="inline-block",a=v.getRelativePath(a.getPath()),this.info.textContent=p.withoutExtension(a));this.meta.textContent="";this.buildContextMenu()},
changeStatus:function(a){a!=this.status&&(null!=this.status&&(this.icon.classList.remove(this.status),this.info.classList.remove(this.status)),this.status=a,null!=a&&(this.icon.classList.add(a),this.info.classList.add(a)))},buildContextMenu:function(){null!=this.contextMenu&&this.contextMenu.dispose();var a=[];null!=d.hxml&&(a.push({label:"Build",command:"xxx:build"}),a.push({type:"separator"}));for(var b=0,c=d.hxmlFiles;b<c.length;){var f=c[b];++b;null!=d.hxml&&d.hxml.getPath()==f||a.push({label:v.getRelativePath(f),
command:"xxx:select-hxml"})}this.contextMenu=atom.contextMenu.add({".status-bar-xxx .info":a})},handleClickInfo:function(a){a.ctrlKey?d.build():null!=d.hxml&&atom.workspace.open(d.hxml.getPath())}};var M=0;String.__name__=!0;Array.__name__=!0;module.exports=d;k.PATTERN=new w("^\\s*(.+):([0-9]+):\\s*(characters*|lines)\\s([0-9]+)(-([0-9]+))?\\s:\\s(.+)$","i");f.VERSION=new w("^(\\d+)\\.(\\d+)\\.(\\d+)(?:[-]([a-z0-9.-]+))?(?:[+]([a-z0-9.-]+))?$","i");f.SANITIZER=new w("[^0-9A-Za-z-]","g");d.EVENT_SELECT_HXML=
"hxml_select";d.EVENT_BUILD="build"})("undefined"!=typeof exports?exports:"undefined"!=typeof window?window:"undefined"!=typeof self?self:this);
